# This file provides examples of Klipper G-Code macros.  The snippets
# in this file may be copied into the main printer.cfg file and
# customized.

# See docs/Config_Reference.md for a description of parameters.

###############
# Load Unload #
###############

# [gcode_macro UNLOAD_FILAMENT]
# description:Unload Filament
# gcode:
#     {% set hotendtemp = params.HOTEND|default(230)|int %}
#     SAVE_GCODE_STATE NAME=unload_state
#     {% if printer.pause_resume.is_paused == False %}                            ; PAUSE active? if not then normal unload with position, heatup, and tip...
#       M104 S{hotendtemp}                                                        ; set & continue hotend temp, default to 230
#       {% if printer.toolhead.homed_axes != 'xyz' %}                             ; Home if not already homed
#         M117 Homing...
#         STATUS_HOMING                                                           ; LEDs show homing
#         G28                                                                     ; Alphaville: Lassie come home, come home lalala
#       {% endif %}
#       G1 Y50 X218 Z50 F3600                                                     ; move toolhead to reachable position and ...
#       M117 Heating
#       STATUS_HEATING                                                            ; LEDs show heating
#       M109 S{hotendtemp}                                                        ; set & wait for hotend temp, default to 230
#       M117 Unloading Filament 
#       STATUS_PRINTING                                                           ; LEDs show printing
#       G91
#       G0 E10 F360                                                               ; extract a bit
#       G0 E5 F3600                                                               ; blob a bit
#       G0 E-22 F3600                                                             ; forming filament Tip for Rapido -> from ERCF V3 ercf_software.cfg 
#       G0 E2 F300
#       G0 E-2.1 F300
#       G0 E2 F300
#       G0 E-2.2 F300
#       G0 E2 F300
#       G0 E-2.3 F300
#       G0 E2 F300
#       G0 E-2.4 F300
#       G0 E2 F300
#       G0 E-2.5 F300
#       G0 E2 F300
#       G0 E-43 F300                                                               ; Filament Tip cooldown till extruder gears for Rapido -> from ERCF V3 ercf_software.cfg 
#       G0 E-100 F3600                                                             ; aaand puke it out fast
#        M117 Fila unloaded, what now?
#     {% else %}                                                                   ; UUPS!! Pause or M600 active, hurry up now, time is Filament 
#       M117 Unloading Filament
#       STATUS_PRINTING                                                            ; LEDs show printing
#       G91
#       G0 E10 F360                                                                ; extract a bit
#       G0 E5 F3600                                                                ; blob a bit
#       G0 E-150 F3600                                                             ; schwupdiwup, away with it
#       M117 Fila unloaded, hurry up for the next!
#     {% endif %}
# #    STATUS_COOLING                                                               ; LEDs show cooling
# #    TURN_OFF_HEATERS                                                             ; cooldown
#     G90
#     STATUS_READY                                                                  ; LEDs show ready
#     RESTORE_GCODE_STATE NAME=unload_state

# [gcode_macro LOAD_FILAMENT]
# description:Load Filament
# gcode:
#     {% set hotendtemp = params.HOTEND|default(230)|int %}
#     SAVE_GCODE_STATE NAME=load_state
#     {% if printer.pause_resume.is_paused == False %}                            ; PAUSE active? if not then normal loading with position, heatup...
#       M104 S{hotendtemp}                                                        ; set & continue hotend temp, default to 230
#       {% if printer.toolhead.homed_axes != 'xyz' %}                             ; Home if not already homed
#         M117 Homing...
#         STATUS_HOMING                                                           ; LEDs show homing
#         G28                                                                     ; Lynyrd Skynyrd: sweet home Alabama Lalala
#       {% endif %}
#       G1 Y50 X218 Z50 F3600                                                     ; move toolhead to reachable position and ...
#       M117 Heating
#       STATUS_HEATING                                                            ; LEDs show heating
#       M109 S{hotendtemp}                                                        ; set & wait for hotend temp, default to 230
#       M117 loading Filament
#       STATUS_PRINTING                                                           ; LEDs show printing
#       G91
#       G1 E200 F360                                                              ; extract 200mm for colour change
#       G1 E5 F3600                                                               ; blob for cleaning Nozzle
#       G1 E-10 F1200                                                             ; retract for non oozing
#       M117 Filament ready...
# #      STATUS_COOLING                                                            ; LEDs show cooling
# #      TURN_OFF_HEATERS
#       G90
#       G0 X218 Y235 F3600                                                        ; park nozzle over bucket
#       STATUS_READY                                                              ; LEDs show Ready
#       RESTORE_GCODE_STATE NAME=load_state
#     {% else %}                                                                  ; UUPS!! Pause or M600 active, hurry up now, printfailure waits for you
#       M117 loading Filament
#       STATUS_PRINTING                                                           ; LEDs show printing
#       G91
#       G1 E200 F360                                                              ; extract 200mm for colour change
#       G1 E5 F3600                                                               ; blob for cleaning Nozzle
#       G1 E-1 F1200                                                              ; retract for non oozing
#       M117 Filament ready, resuming...
#       G90
#       RESTORE_GCODE_STATE NAME=load_state
#       RESUME
#     {% endif %}


# [gcode_macro M600]
# description: Filament change
# gcode: 
#     PAUSE Z_MIN=50
#     UNLOAD_FILAMENT
    
######################################################################
# Start Print and End Print
######################################################################

# Replace the slicer's custom start and end g-code scripts with
# START_PRINT and END_PRINT. See docs/Slicers.md for more information on using these macros.

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    # Start bed heating
    M140 S{BED_TEMP}
    # Use absolute coordinates
    G90
    # Reset the G-Code Z offset (adjust Z offset if needed)
    SET_GCODE_OFFSET Z=0.0
    # Clear Bed Mesh
    BED_MESH_CLEAR
    # Home the printer
    G28
    G1 Z10 F3000
    # Wait for bed to reach temperature
    M190 S{BED_TEMP}
    BED_MESH_CALIBRATE
    Smart_Park
    # Set and wait for nozzle to reach temperature
    M109 S{EXTRUDER_TEMP}
    # Adaptiver Purge
    LINE_PURGE

[gcode_macro END_PRINT]
gcode:
    # Sicherheit: Absolut
    G90
    # Retract solange Düse noch heiß ist
    G91
    G1 E-3 F1800
    G90
    G92 E0
    # Kopf anheben
    G91
    G1 Z25 F3000
    G90
    # Bett nach vorne (Switchwire/Enderwire-typisch)
    G1 X{printer.toolhead.axis_maximum.x - 15} Y{printer.toolhead.axis_maximum.y - 15} F6000
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Disable steppers
    G4 P500
    M84

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    # Status / Sicherheit
    G90

    # Falls gedruckt wurde: Retract solange noch heiß
    G91
    G1 E-3 F1800
    G90
    G92 E0

    # Kopf anheben
    G1 Z20 F3000

    # Bett nach vorne fahren (parametrisch)
    G1 Y{printer.toolhead.axis_maximum.y - 10} F6000

    # Heizer & Lüfter aus
    M104 S0
    M140 S0
    M106 S0

    # Kurze Pause für Mechanik
    G4 P500

    # Stepper aus
    M84

    # Original CANCEL_PRINT ausführen (State reset)
    BASE_CANCEL_PRINT

######################################################################
# Filament Change
######################################################################

# M600: Filament Change. This macro will pause the printer, move the
# tool to the change position, and retract the filament 50mm. Adjust
# the retraction settings for your own extruder. After filament has
# been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

[pause_resume]

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state

######################################################################
# Override M117 command with rawparams
######################################################################

# The macro below will override the default M117 command to echo the message.
#
# It uses the rawparams pseudo-variable that contains the full unparsed
# parameters that was passed to the M117 command.
#
# As this can include comments, we are trimming the text when a `;` or `#` is
# found, and escaping any existing `"`

[gcode_macro M117]
rename_existing: M117.1
gcode:
  {% if rawparams %}
    {% set escaped_msg = rawparams.split(';', 1)[0].split('\x23', 1)[0]|replace('"', '\\"') %}
    SET_DISPLAY_TEXT MSG="{escaped_msg}"
    RESPOND TYPE=command MSG="{escaped_msg}"
  {% else %}
    SET_DISPLAY_TEXT
  {% endif %}

# SDCard 'looping' (aka Marlin M808 commands) support
#
# Support SDCard looping
[sdcard_loop]

# 'Marlin' style M808 compatibility macro for SDCard looping
[gcode_macro M808]
gcode:
    {% if params.K is not defined and params.L is defined %}SDCARD_LOOP_BEGIN COUNT={params.L|int}{% endif %}
    {% if params.K is not defined and params.L is not defined %}SDCARD_LOOP_END{% endif %}
    {% if params.K is defined and params.L is not defined %}SDCARD_LOOP_DESIST{% endif %}

# Cancel object (aka Marlin/RRF M486 commands) support
#
# Enable object exclusion
[exclude_object]

[gcode_macro M486]
gcode:
  # Parameters known to M486 are as follows:
  #   [C<flag>] Cancel the current object
  #   [P<index>] Cancel the object with the given index
  #   [S<index>] Set the index of the current object.
  #       If the object with the given index has been canceled, this will cause
  #       the firmware to skip to the next object. The value -1 is used to
  #       indicate something that isn’t an object and shouldn’t be skipped.
  #   [T<count>] Reset the state and set the number of objects
  #   [U<index>] Un-cancel the object with the given index. This command will be
  #       ignored if the object has already been skipped

  {% if 'exclude_object' not in printer %}
    {action_raise_error("[exclude_object] is not enabled")}
  {% endif %}

  {% if 'T' in params %}
    EXCLUDE_OBJECT RESET=1

    {% for i in range(params.T | int) %}
      EXCLUDE_OBJECT_DEFINE NAME={i}
    {% endfor %}
  {% endif %}

  {% if 'C' in params %}
    EXCLUDE_OBJECT CURRENT=1
  {% endif %}

  {% if 'P' in params %}
    EXCLUDE_OBJECT NAME={params.P}
  {% endif %}

  {% if 'S' in params %}
    {% if params.S == '-1' %}
      {% if printer.exclude_object.current_object %}
        EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object}
      {% endif %}
    {% else %}
      EXCLUDE_OBJECT_START NAME={params.S}
    {% endif %}
  {% endif %}

  {% if 'U' in params %}
    EXCLUDE_OBJECT RESET=1 NAME={params.U}
  {% endif %}

